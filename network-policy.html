<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>NetworkPolicy - go4clouds - The Best Practice Guide to Kubernetes</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="**go4clouds** is open source Kubernetes tutorial for application developers">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="container-runtime.html"><strong aria-hidden="true">2.</strong> Containers</a></li><li class="chapter-item expanded "><a href="kubernetes-introduction.html"><strong aria-hidden="true">3.</strong> Kubernetes</a></li><li class="chapter-item expanded "><a href="cluster-overview.html"><strong aria-hidden="true">4.</strong> Cluster status</a></li><li class="chapter-item expanded "><a href="pods-operations.html"><strong aria-hidden="true">5.</strong> Pods</a></li><li class="chapter-item expanded "><a href="advanced-pods.html"><strong aria-hidden="true">6.</strong> Advanced pods</a></li><li class="chapter-item expanded "><a href="application-deployment.html"><strong aria-hidden="true">7.</strong> ReplicaSet and Deployment</a></li><li class="chapter-item expanded "><a href="using-configmaps-and-secrets.html"><strong aria-hidden="true">8.</strong> ConfigMaps and Secrets</a></li><li class="chapter-item expanded "><a href="persistent-volume.html"><strong aria-hidden="true">9.</strong> PersistentVolume</a></li><li class="chapter-item expanded "><a href="service-concept.html"><strong aria-hidden="true">10.</strong> Services</a></li><li class="chapter-item expanded "><a href="ingress-controller.html"><strong aria-hidden="true">11.</strong> Ingress controller</a></li><li class="chapter-item expanded "><a href="loadbalancer-installation.html"><strong aria-hidden="true">12.</strong> LoadBalancer installation</a></li><li class="chapter-item expanded "><a href="getting-highavailable.html"><strong aria-hidden="true">13.</strong> High-availability</a></li><li class="chapter-item expanded "><a href="kubernetes-cni.html"><strong aria-hidden="true">14.</strong> Kubernetes CNI</a></li><li class="chapter-item expanded "><a href="network-policy.html" class="active"><strong aria-hidden="true">15.</strong> NetworkPolicy</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">go4clouds - The Best Practice Guide to Kubernetes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/go4clouds/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lab-exercises-for-network-policy"><a class="header" href="#lab-exercises-for-network-policy">Lab Exercises for Network Policy</a></h1>
<h2 id="exercise-0---testing-network-policy"><a class="header" href="#exercise-0---testing-network-policy">Exercise 0 - Testing Network Policy</a></h2>
<p>Create an nginx deployment and expose it via a service</p>
<pre><code class="language-shell">kubectl create deployment nginx --image=registry.k8s:5000/nginx
</code></pre>
<p>Output:</p>
<pre><code>deployment.apps/nginx created
</code></pre>
<p>Expose the Deployment through a Service called nginx.</p>
<pre><code class="language-shell">kubectl expose deployment nginx --port=8080 --target-port=80
</code></pre>
<p>Output:</p>
<pre><code>service/nginx exposed
</code></pre>
<p>The above commands create a Deployment with an nginx Pod and expose the Deployment through a Service named nginx. The nginx Pod and Deployment are found in the default namespace.</p>
<pre><code class="language-shell">kubectl get svc,pod
</code></pre>
<p>Output:</p>
<pre><code>NAME                        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
service/kubernetes          10.100.0.1    &lt;none&gt;        443/TCP    46m
service/nginx               10.100.0.16   &lt;none&gt;        8080/TCP     33s

NAME                        READY         STATUS        RESTARTS   AGE
pod/nginx-701339712-e0qfq   1/1           Running       0          35s
</code></pre>
<p>Test the service by accessing it from another Pod
You should be able to access the new nginx service from other Pods. To access the nginx Service from another Pod in the default namespace, start a busybox container:</p>
<pre><code class="language-shell">kubectl run busybox --rm -ti --image=k8s.gcr.io/busybox -- /bin/sh
</code></pre>
<p>In your shell, run the following command:</p>
<pre><code class="language-shell">wget --spider --timeout=1 http://nginx:8080
</code></pre>
<p>Output:</p>
<pre><code>Connecting to nginx:8080 (10.101.252.93:8080)
</code></pre>
<p>Limit access to the nginx service
To limit the access to the nginx service so that only Pods with the label <code>access: enabled</code> can query it, create a NetworkPolicy object as follows:</p>
<pre><code class="language-shell">cat &gt; access-nginx.yaml &lt;&lt; EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: access-nginx
spec:
  podSelector:
    matchLabels:
      app: nginx
  ingress:
  - from:
    - podSelector:
        matchLabels:
          access: enabled
EOF
</code></pre>
<p>The name of a NetworkPolicy object must be a valid DNS subdomain name.</p>
<p>Note: NetworkPolicy includes a podSelector which selects the grouping of Pods to which the policy applies. You can see this policy selects Pods with the label app=nginx. The label was automatically added to the Pod in the nginx Deployment. An empty podSelector selects all pods in the namespace.
Assign the policy to the service
Use kubectl to create a NetworkPolicy from the above access-nginx.yaml file:</p>
<pre><code class="language-shell">kubectl apply -f access-nginx.yaml
</code></pre>
<p>Output:</p>
<pre><code>networkpolicy.networking.k8s.io/access-nginx created
</code></pre>
<p>Test access to the service when access label is not defined
When you attempt to access the nginx Service from a Pod without the correct labels, the request times out:</p>
<pre><code class="language-shell">kubectl run busybox --rm -ti --image=k8s.gcr.io/busybox -- /bin/sh
</code></pre>
<p>In your shell, run the command:</p>
<pre><code class="language-shell">wget --spider --timeout=1 http://nginx:8080
</code></pre>
<p>Output:</p>
<pre><code>Connecting to nginx (10.100.0.16:80)
wget: download timed out
</code></pre>
<p>Define access label and test again
You can create a Pod with the correct labels to see that the request is allowed:</p>
<pre><code class="language-shell">kubectl run busybox --rm -ti --labels=&quot;access=enabled&quot; --image=k8s.gcr.io/busybox -- /bin/sh
</code></pre>
<p>In your shell, run the command:</p>
<pre><code class="language-shell">wget --spider --timeout=1 http://nginx:8080
</code></pre>
<p>Output:</p>
<pre><code>Connecting to nginx (10.100.0.16:8080)
remote file exists
</code></pre>
<h2 id="exercise-1---advanced-network-policy-for-guestbook-with-redis-and-php"><a class="header" href="#exercise-1---advanced-network-policy-for-guestbook-with-redis-and-php">Exercise 1 - <a href="https://kubernetes.io/docs/tutorials/stateless-application/guestbook/">Advanced Network Policy for guestbook with Redis and PHP</a></a></h2>
<ul>
<li>Create guestbook namespace</li>
</ul>
<pre><code class="language-shell">kubectl create namespace guestbook
</code></pre>
<ul>
<li>Deny all ingress and egress traffic for namespace <code>guestbook</code></li>
</ul>
<pre><code class="language-shell">cat &gt; guestbook-deny-all.yaml &lt;&lt;EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: guestbook-deny-all
  namespace: guestbook
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
EOF
</code></pre>
<ul>
<li>Apply deny all Network Policy</li>
</ul>
<pre><code class="language-shell">kubectl apply -f guestbook-deny-all.yaml
</code></pre>
<ul>
<li>Allow DNS traffic for all pods in <code>guestbook</code> namespace</li>
</ul>
<pre><code class="language-shell">cat &gt; guestbook-allow-dns.yaml &lt;&lt;EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: guestbook-allow-dns
  namespace: guestbook
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  # allow DNS resolution
  - ports:
    - port: 53
      protocol: UDP
    - port: 53
      protocol: TCP
EOF
</code></pre>
<ul>
<li>Apply DNS Network Policy rules</li>
</ul>
<pre><code class="language-shell">kubectl apply -f guestbook-allow-dns.yaml
</code></pre>
<ul>
<li>Create Redis leader service</li>
</ul>
<pre><code class="language-shell">cat &gt; deploy-redis-leader.yaml &lt;&lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-leader
  namespace: guestbook
  labels:
    app: redis
    role: leader
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
        role: leader
        tier: backend
    spec:
      containers:
      - name: leader
        image: &quot;registry.k8s:5000/redis:6.0.5&quot;
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 6379
EOF
</code></pre>
<ul>
<li>Apply readis-leader manifest</li>
</ul>
<pre><code class="language-shell">kubectl apply -f deploy-redis-leader.yaml
</code></pre>
<ul>
<li>Verify that Redis leader pod is running</li>
</ul>
<pre><code class="language-shell">kubectl get pods -n guestbook
</code></pre>
<p>Output:</p>
<pre><code>NAME                           READY     STATUS    RESTARTS   AGE
redis-leader-343230949-qfvrq   1/1       Running   0          43s
</code></pre>
<ul>
<li>Check logs from Redis leader</li>
</ul>
<pre><code class="language-shell">kubectl logs -n guestbook deployment/redis-leader
</code></pre>
<p>Output:</p>
<pre><code>1:C 15 Jul 2021 14:23:25.535 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
1:C 15 Jul 2021 14:23:25.535 # Redis version=6.0.5, bits=64, commit=00000000, modified=0, pid=1, just started
1:C 15 Jul 2021 14:23:25.535 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
1:M 15 Jul 2021 14:23:25.536 * Running mode=standalone, port=6379.
1:M 15 Jul 2021 14:23:25.537 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
1:M 15 Jul 2021 14:23:25.537 # Server initialized
1:M 15 Jul 2021 14:23:25.537 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
1:M 15 Jul 2021 14:23:25.537 * Ready to accept connections
</code></pre>
<ul>
<li>Expose Redis leader </li>
</ul>
<pre><code class="language-shell">kubectl expose deployment -n guestbook redis-leader --port=6379
</code></pre>
<ul>
<li>Verify service</li>
</ul>
<pre><code class="language-shell">kubectl get svc -n guestbook redis-leader
</code></pre>
<p>Output:</p>
<pre><code>NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
redis-leader   ClusterIP   10.110.99.222   &lt;none&gt;        6379/TCP   20s
</code></pre>
<ul>
<li>Define Redis followers</li>
</ul>
<pre><code class="language-shell">cat &gt; deploy-redis-follower.yaml &lt;&lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-follower
  namespace: guestbook
  labels:
    app: redis
    role: follower
    tier: backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
        role: follower
        tier: backend
    spec:
      containers:
      - name: follower
        image: gcr.io/google_samples/gb-redis-follower:v2
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 6379
EOF
</code></pre>
<ul>
<li>Create Redis follower deployment</li>
</ul>
<pre><code class="language-shell">kubectl apply -f deploy-redis-follower.yaml
</code></pre>
<ul>
<li>Check logs for Redis follower pods</li>
</ul>
<pre><code class="language-shell">kubectl logs -n guestbook redis-follower-&lt;Tab&gt;
</code></pre>
<p>Output:</p>
<pre><code>10:S 27 Jul 2021 10:15:23.836 * Ready to accept connections
10:S 27 Jul 2021 10:15:23.836 * Connecting to MASTER redis-leader:6379
10:S 27 Jul 2021 10:15:23.843 * MASTER &lt;-&gt; REPLICA sync started
10:S 27 Jul 2021 10:16:24.068 # Timeout connecting to the MASTER...
10:S 27 Jul 2021 10:16:24.068 * Connecting to MASTER redis-leader:6379
10:S 27 Jul 2021 10:16:24.069 * MASTER &lt;-&gt; REPLICA sync started
10:S 27 Jul 2021 10:17:25.313 # Timeout connecting to the MASTER...
</code></pre>
<p>Wait and look for</p>
<pre><code># Timeout connecting to the MASTER...
</code></pre>
<ul>
<li>Allow traffic from Redis follower to Redis leader</li>
</ul>
<pre><code class="language-shell">cat &gt; guestbook-allow-redis-sync.yaml&lt;&lt;EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: guestobook-allow-redis-sync
  namespace: guestbook
spec:
  podSelector:
    matchLabels:
      app: redis
      role: leader
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: guestbook
    - podSelector:
        matchLabels:
          app: redis
          role: follower
    ports:
    - protocol: TCP
      port: 6379
EOF
</code></pre>
<ul>
<li>Check once again logs from Redis followers</li>
</ul>
<pre><code class="language-shell">kubectl logs -n guestbook redis-follower-&lt;Tab&gt;
</code></pre>
<p>Output:</p>
<pre><code>10:S 15 Jul 2021 14:53:07.966 * Connecting to MASTER redis-leader:6379
10:S 15 Jul 2021 14:53:07.970 * MASTER &lt;-&gt; REPLICA sync started
</code></pre>
<ul>
<li>Expose Redis follower service</li>
</ul>
<pre><code class="language-shell">kubectl expose deployment -n guestbook redis-follower --port=6379
</code></pre>
<ul>
<li>Check list of services</li>
</ul>
<pre><code class="language-shell">kubectl get svc -n guestbook
</code></pre>
<p>Output:</p>
<pre><code>NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
redis-follower   ClusterIP   10.98.8.13      &lt;none&gt;        6379/TCP   53s
redis-leader     ClusterIP   10.110.99.222   &lt;none&gt;        6379/TCP   49m
</code></pre>
<ul>
<li>Define frontend YAML manifest application</li>
</ul>
<pre><code class="language-shell">cat &gt; deploy-frontend.yaml &lt;&lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: guestbook
spec:
  replicas: 3
  selector:
    matchLabels:
        app: guestbook
        tier: frontend
  template:
    metadata:
      labels:
        app: guestbook
        tier: frontend
    spec:
      containers:
      - name: php-redis
        image: gcr.io/google_samples/gb-frontend:v5
        env:
        - name: GET_HOSTS_FROM
          value: &quot;dns&quot;
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 80
EOF
</code></pre>
<ul>
<li>Apply YAML deployment </li>
</ul>
<pre><code class="language-shell">kubectl apply -f deploy-frontend.yaml
</code></pre>
<ul>
<li>Check pods status for frontend deployment</li>
</ul>
<pre><code class="language-shell">kubectl get pods -l app=guestbook -l tier=frontend -n guestbook
</code></pre>
<p>Output:</p>
<pre><code>NAME                        READY   STATUS    RESTARTS   AGE
frontend-85595f5bf9-2lmnb   1/1     Running   0          7m20s
frontend-85595f5bf9-bv9sx   1/1     Running   0          7m19s
frontend-85595f5bf9-p974r   1/1     Running   0          7m19s
</code></pre>
<ul>
<li>Expose frontend application with LoadBalancer</li>
</ul>
<pre><code class="language-shell">kubectl expose deployment -n guestbook frontend --port=80 --type=LoadBalancer
</code></pre>
<ul>
<li>Check service </li>
</ul>
<pre><code class="language-shell">kubectl get svc -n guestbook
</code></pre>
<p>Output:</p>
<pre><code>NAME             TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
frontend         LoadBalancer   10.106.92.142   10.168.0.50   80:30547/TCP   7m22s
redis-follower   ClusterIP      10.98.8.13      &lt;none&gt;        6379/TCP       15h
redis-leader     ClusterIP      10.110.99.222   &lt;none&gt;        6379/TCP       16h
</code></pre>
<ul>
<li>Use <code>EXTERNALIP</code> and try to connect </li>
</ul>
<pre><code class="language-shell">EXTERNALIP=`kubectl get svc -n guestbook frontend -o jsonpath=&quot;{.status.loadBalancer.ingress[0].ip}&quot;`
curl --connect-timeout 5 http://$EXTERNALIP
</code></pre>
<p>Output:</p>
<pre><code>curl: (28) Connection timed out after 5001 milliseconds
</code></pre>
<ul>
<li>Prepare Network Policy to allow connection to frontend</li>
</ul>
<pre><code class="language-shell">cat &gt; allow-frontend.yaml &lt;&lt;EOF
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-frontend
  namespace: guestbook
spec:
  podSelector:
    matchLabels:
      app: guestbook
      tier: frontend
  ingress:
  - ports:
    - port: 80
EOF
</code></pre>
<ul>
<li>Apply frontend Network Policy</li>
</ul>
<pre><code class="language-shell">kubectl apply -f allow-frontend.yaml
</code></pre>
<ul>
<li>Use <code>EXTERNALIP</code> and try to connect once again</li>
</ul>
<pre><code class="language-shell">EXTERNALIP=`kubectl get svc -n guestbook frontend -o jsonpath=&quot;{.status.loadBalancer.ingress[0].ip}&quot;`
curl --connect-timeout 5 http://$EXTERNALIP
</code></pre>
<p>Output:</p>
<pre><code>&lt;html ng-app=&quot;redis&quot;&gt;
  &lt;head&gt;
    &lt;title&gt;Guestbook&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css&quot;&gt;
    &lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.2.12/angular.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;controllers.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.13.0/ui-bootstrap-tpls.js&quot;&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body ng-controller=&quot;RedisCtrl&quot;&gt;
    &lt;div style=&quot;width: 50%; margin-left: 20px&quot;&gt;
      &lt;h2&gt;Guestbook&lt;/h2&gt;
    &lt;form&gt;
    &lt;fieldset&gt;
    &lt;input ng-model=&quot;msg&quot; placeholder=&quot;Messages&quot; class=&quot;form-control&quot; type=&quot;text&quot; name=&quot;input&quot;&gt;&lt;br&gt;
    &lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; ng-click=&quot;controller.onRedis()&quot;&gt;Submit&lt;/button&gt;
    &lt;/fieldset&gt;
    &lt;/form&gt;
    &lt;div&gt;
      &lt;div ng-repeat=&quot;msg in messages track by $index&quot;&gt;
        {{msg}}
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<ul>
<li>Last step is to allow connection from frontend application to redis instances</li>
</ul>
<pre><code class="language-shell">cat &gt; allow-fronted-redis.yaml &lt;&lt;EOF
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-redis
  namespace: guestbook
spec:
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: guestbook
    ports:
    - port: 6380
      protocol: TCP
    - port: 6379
      protocol: TCP
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis-frontend
  namespace: guestbook
spec:
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: redis
  - ports:
    - port: 6380
      protocol: TCP
    - port: 6379
      protocol: TCP
  podSelector:
    matchLabels:
      app: guestbook
  policyTypes:
  - Egress
EOF
</code></pre>
<ul>
<li>Apply Network Policy</li>
</ul>
<pre><code class="language-shell">kubectl apply -f allow-fronted-redis.yaml
</code></pre>
<ul>
<li>Check connection using Webrowser</li>
</ul>
<pre><code>http://&lt;EXTERNALIP&gt;
</code></pre>
<p>Note: This can be done by using graphical interface to server or by SSH port forwarding from your lab environment to your desktop e.g.</p>
<pre><code>ssh -L 8080:EXTERNALIP:80 -l tux -p &lt;PORT&gt; &lt;LAB_SERVER_IP&gt;
</code></pre>
<p>Then localy on desktop open </p>
<p>http://localhost:8080</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="kubernetes-cni.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="kubernetes-cni.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
